<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒè¯•æ§åˆ¶å° - Just in Time</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .debug-section {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .debug-title {
            color: #333;
            border-bottom: 2px solid #6366f1;
            padding-bottom: 10px;
        }
        .test-btn {
            background: #6366f1;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            margin: 5px;
            cursor: pointer;
        }
        .test-btn:hover {
            background: #5855eb;
        }
        .status {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
        .success { background: #d1fae5; color: #065f46; }
        .error { background: #fee2e2; color: #991b1b; }
        .warning { background: #fef3c7; color: #92400e; }
        #log {
            height: 200px;
            overflow-y: auto;
            background: #1f2937;
            color: #f9fafb;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ Just in Time è°ƒè¯•æ§åˆ¶å°</h1>
    
    <div class="debug-section">
        <h2 class="debug-title">åº”ç”¨çŠ¶æ€æ£€æŸ¥</h2>
        <button class="test-btn" onclick="checkAppState()">æ£€æŸ¥åº”ç”¨çŠ¶æ€</button>
        <button class="test-btn" onclick="checkWeatherService()">æ£€æŸ¥å¤©æ°”æœåŠ¡</button>
        <button class="test-btn" onclick="checkNavigation()">æ£€æŸ¥å¯¼èˆª</button>
        <button class="test-btn" onclick="checkCanvas()">æ£€æŸ¥Canvas</button>
        <div id="app-status"></div>
    </div>
    
    <div class="debug-section">
        <h2 class="debug-title">åŠŸèƒ½æµ‹è¯•</h2>
        <button class="test-btn" onclick="testIntroAnimation()">æµ‹è¯•å…¥åœºåŠ¨ç”»</button>
        <button class="test-btn" onclick="testPageNavigation()">æµ‹è¯•é¡µé¢å¯¼èˆª</button>
        <button class="test-btn" onclick="testBackgroundChange()">æµ‹è¯•èƒŒæ™¯å˜åŒ–</button>
        <button class="test-btn" onclick="clearAllData()">æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
        <div id="test-results"></div>
    </div>
    
    <div class="debug-section">
        <h2 class="debug-title">æ§åˆ¶å°æ—¥å¿—</h2>
        <button class="test-btn" onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        <div id="log"></div>
    </div>
    
    <div class="debug-section">
        <h2 class="debug-title">å¿«é€Ÿè®¿é—®</h2>
        <a href="index.html" class="test-btn" target="_blank">æ‰“å¼€ä¸»åº”ç”¨</a>
        <button class="test-btn" onclick="reloadMainApp()">é‡æ–°åŠ è½½ä¸»åº”ç”¨</button>
    </div>

    <script>
        // æ•è·æ§åˆ¶å°æ—¥å¿—
        const logDiv = document.getElementById('log');
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function addLog(type, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? '#fca5a5' : 
                                  type === 'warn' ? '#fbbf24' : '#a7f3d0';
            logEntry.textContent = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog('log', ...args);
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addLog('error', ...args);
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addLog('warn', ...args);
        };
        
        function showStatus(elementId, message, type = 'success') {
            const element = document.getElementById(elementId);
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            element.appendChild(statusDiv);
        }
        
        function clearStatus(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }
        
        function checkAppState() {
            clearStatus('app-status');
            
            try {
                // æ£€æŸ¥ä¸»è¦å¯¹è±¡æ˜¯å¦å­˜åœ¨
                const mainWindow = window.open('', 'mainApp');
                if (!mainWindow || mainWindow.closed) {
                    showStatus('app-status', 'ä¸»åº”ç”¨çª—å£æœªæ‰“å¼€', 'warning');
                    return;
                }
                
                const checks = [
                    { name: 'appState', obj: mainWindow.appState },
                    { name: 'app', obj: mainWindow.app },
                    { name: 'dynamicBg', obj: mainWindow.dynamicBg },
                    { name: 'seasonsTree', obj: mainWindow.seasonsTree },
                    { name: 'flowerGenerator', obj: mainWindow.flowerGenerator }
                ];
                
                checks.forEach(check => {
                    const status = check.obj ? 'success' : 'error';
                    const message = `${check.name}: ${check.obj ? 'âœ… å·²åˆå§‹åŒ–' : 'âŒ æœªåˆå§‹åŒ–'}`;
                    showStatus('app-status', message, status);
                });
                
            } catch (error) {
                showStatus('app-status', `æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function checkWeatherService() {
            clearStatus('app-status');
            
            // ç®€å•çš„å¤©æ°”APIæµ‹è¯•
            fetch('https://api.weatherapi.com/v1/current.json?key=f080dd8eccd341b4a06152132251207&q=Beijing&aqi=no')
                .then(response => {
                    if (response.ok) {
                        showStatus('app-status', 'âœ… å¤©æ°”APIè¿æ¥æ­£å¸¸', 'success');
                        return response.json();
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                })
                .then(data => {
                    showStatus('app-status', `å¤©æ°”æ•°æ®: ${data.location.name} ${data.current.temp_c}Â°C`, 'success');
                })
                .catch(error => {
                    showStatus('app-status', `âŒ å¤©æ°”APIé”™è¯¯: ${error.message}`, 'error');
                });
        }
        
        function checkNavigation() {
            clearStatus('app-status');
            const pages = ['home', 'stats', 'wardrobe', 'settings'];
            
            pages.forEach(page => {
                const pageEl = document.querySelector(`#page-${page}`);
                const navEl = document.querySelector(`[data-page="${page}"]`);
                
                const pageStatus = pageEl ? 'âœ…' : 'âŒ';
                const navStatus = navEl ? 'âœ…' : 'âŒ';
                
                showStatus('app-status', 
                    `é¡µé¢ ${page}: ${pageStatus} å¯¼èˆª: ${navStatus}`, 
                    pageEl && navEl ? 'success' : 'error'
                );
            });
        }
        
        function checkCanvas() {
            clearStatus('app-status');
            
            const canvases = [
                'dynamic-background-canvas',
                'atmosphere-canvas'
            ];
            
            canvases.forEach(canvasId => {
                const canvas = document.getElementById(canvasId);
                const status = canvas ? 'âœ… å­˜åœ¨' : 'âŒ ç¼ºå¤±';
                const type = canvas ? 'success' : 'error';
                
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    const hasContext = ctx ? 'âœ…' : 'âŒ';
                    showStatus('app-status', 
                        `Canvas ${canvasId}: ${status}, Context: ${hasContext}`, 
                        type
                    );
                } else {
                    showStatus('app-status', `Canvas ${canvasId}: ${status}`, type);
                }
            });
        }
        
        function testIntroAnimation() {
            clearStatus('test-results');
            localStorage.removeItem('hasVisited');
            showStatus('test-results', 'å·²æ¸…é™¤è®¿é—®è®°å½•ï¼Œåˆ·æ–°é¡µé¢å°†æ˜¾ç¤ºå…¥åœºåŠ¨ç”»', 'success');
        }
        
        function testPageNavigation() {
            clearStatus('test-results');
            const pages = ['home', 'stats', 'wardrobe', 'settings'];
            let currentIndex = 0;
            
            const switchPage = () => {
                const page = pages[currentIndex];
                const navItem = document.querySelector(`[data-page="${page}"]`);
                
                if (navItem) {
                    navItem.click();
                    showStatus('test-results', `åˆ‡æ¢åˆ° ${page} é¡µé¢`, 'success');
                } else {
                    showStatus('test-results', `æ‰¾ä¸åˆ° ${page} é¡µé¢å¯¼èˆª`, 'error');
                }
                
                currentIndex = (currentIndex + 1) % pages.length;
                
                if (currentIndex === 0) {
                    showStatus('test-results', 'é¡µé¢å¯¼èˆªæµ‹è¯•å®Œæˆ', 'success');
                } else {
                    setTimeout(switchPage, 1000);
                }
            };
            
            switchPage();
        }
        
        function testBackgroundChange() {
            clearStatus('test-results');
            
            if (window.dynamicBg) {
                const times = [6, 12, 18, 23]; // ä¸åŒæ—¶é—´æ®µ
                let index = 0;
                
                const changeTime = () => {
                    const hour = times[index];
                    window.dynamicBg.setTimeForTesting(hour);
                    showStatus('test-results', `è®¾ç½®æ—¶é—´ä¸º ${hour}:00`, 'success');
                    
                    index = (index + 1) % times.length;
                    if (index !== 0) {
                        setTimeout(changeTime, 2000);
                    } else {
                        showStatus('test-results', 'èƒŒæ™¯å˜åŒ–æµ‹è¯•å®Œæˆ', 'success');
                    }
                };
                
                changeTime();
            } else {
                showStatus('test-results', 'åŠ¨æ€èƒŒæ™¯æœªåˆå§‹åŒ–', 'error');
            }
        }
        
        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰åº”ç”¨æ•°æ®å—ï¼Ÿ')) {
                localStorage.clear();
                sessionStorage.clear();
                showStatus('test-results', 'æ‰€æœ‰æ•°æ®å·²æ¸…é™¤', 'warning');
            }
        }
        
        function clearLog() {
            logDiv.innerHTML = '';
        }
        
        function reloadMainApp() {
            if (window.mainApp) {
                window.mainApp.location.reload();
            } else {
                window.open('index.html', 'mainApp');
            }
        }
        
        // è‡ªåŠ¨è¿è¡ŒåŸºç¡€æ£€æŸ¥
        setTimeout(() => {
            console.log('è°ƒè¯•æ§åˆ¶å°å·²åŠ è½½');
            checkAppState();
        }, 1000);
    </script>
</body>
</html>